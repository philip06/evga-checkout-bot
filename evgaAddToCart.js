console.log("evga add to cart script started");

const addToCart = (card, modelNumber) => {
	console.log("buy: ", modelNumber);
	const checkoutButton = card.querySelector("div > input.btnBigAddCart");
	checkoutButton.click();
}

let modelNumbers = [];

chrome.storage.sync.get({
	modelNumbers: '10G-P5-3897-RX,08G-P5-3667-RX,08G-P5-3665-RX,08G-P5-3663-RX,10G-P5-3895-RX,10G-P5-3885-RX,10G-P5-3883-RX,10G-P5-3881-RX,08G-P5-3767-RX,08G-P5-3755-RX,08G-P5-3753-RX,08G-P5-3751-RX,10G-P5-3898-RX,10G-P5-3888-RX,10G-P5-3899-RX,10G-P5-3889-RX,24G-P5-3987-RX,24G-P5-3985-RX,24G-P5-3975-RX,24G-P5-3973-RX,24G-P5-3971-RX,24G-P5-3988-RX,24G-P5-3989-RX,24G-P5-3978-RX,24G-P5-3998-RX,24G-P5-3999-RX,24G-P5-3979-RX,10G-P5-3897-RL,10G-P5-3885-RL,10G-P5-3895-RL,10G-P5-3883-RL,10G-P5-3881-RL,10G-P5-3898-RL,10G-P5-3888-RL,10G-P5-3899-RL,10G-P5-3889-RL,08G-P5-3767-RL,08G-P5-3755-RL,08G-P5-3751-RL,08G-P5-3753-RL,12G-P5-3657-RX,12G-P5-3655-RX,08G-P5-3667-RL,08G-P5-3663-RL,08G-P5-3665-RL,08G-P5-3797-RX,08G-P5-3785-RX,08G-P5-3783-RX,12G-P5-3967-RX,12G-P5-3953-RX,12G-P5-3968-RX,12G-P5-3958-RX,12G-P5-3969-RX,12G-P5-3959-RX,08G-P4-3062-RX,08G-P4-3065-RX,08G-P4-3067-RX,08G-P4-3161-RX,08G-P4-3162-RX,08G-P4-3163-RX,06G-P4-2060-RX,06G-P4-2061-RX,06G-P4-2062-RX,06G-P4-2063-RX,06G-P4-2065-RX,06G-P4-2066-RX,06G-P4-2067-RX,06G-P4-2068-RX,06G-P4-2163-RX,06G-P4-2166-RX,06G-P4-2167-RX,06G-P4-1061-RX,06G-P4-1066-RX,06G-P4-1068-RX,06G-P4-1261-RX,06G-P4-1263-RX,06G-P4-1265-RX,06G-P4-1267-RX,06G-P4-1665-RX,06G-P4-1667-RX,06G-P4-1065-RX,06G-P4-1067-RX,06G-P4-1160-RX,06G-P4-1161-RX,06G-P4-1163-RX,06G-P4-1165-RX,06G-P4-1167-RX,04G-P4-1251-RX,04G-P4-1355-RX,04G-P4-1357-RX,04G-P4-1055-RX,04G-P4-1057-RX,04G-P4-1151-RX,04G-P4-1153-RX,04G-P4-1155-RX,04G-P4-1157-RX,04G-P4-1255-RX,04G-P4-1257-RX,04G-P4-1455-RX,04G-P4-1457-RX,08G-P4-2072-RX,08G-P4-3070-RX,08G-P4-3071-RX,08G-P4-3172-RX,08G-P4-3173-RX,08G-P4-3175-RX,08G-P4-3178-RX,08G-P4-3273-RX,08G-P4-3277-RX,08G-P4-3377-RX,08G-P4-1071-RX,08G-P4-1171-RX,08G-P4-2070-RX,08G-P4-2071-RX,08G-P4-2171-RX,08G-P4-2172-RX,08G-P4-2173-RX,08G-P4-2273-RX,08G-P4-2277-RX,06G-P4-5161-RX,06G-P4-6161-RX,06G-P4-6163-RX,06G-P4-6262-RX,06G-P4-6264-RX,06G-P4-6265-RX,06G-P4-6266-RX,06G-P4-6267-RX,06G-P4-6268-RX,06G-P4-6366-RX,06G-P4-6368-RX,06G-P4-6667-RX,06G-P4-6766-RX,06G-P4-6768-RX,08G-P4-5670-RX,08G-P4-5671-RX,08G-P4-5678-RX,08G-P4-6678-RX,08G-P4-6775-RX,08G-P4-5170-RX,08G-P4-5171-RX,08G-P4-5173-RX,08G-P4-6170-RX,08G-P4-6171-RX,08G-P4-6173-RX,08G-P4-6173-RX,08G-P4-6178-RX,08G-P4-6274-RX,08G-P4-6276-RX,08G-P4-6278-RX,08G-P4-6571-RX,08G-P4-6573-RX,08G-P4-6674-RX,08G-P4-6676-RX,03G-P4-5160-RX,03G-P4-6160-RX,03G-P4-6162-RX,03G-P4-6165-RX,03G-P4-6166-RX,03G-P4-6167-RX,03G-P4-6168-RX,03G-P4-6263-RX,03G-P4-6365-RX,03G-P4-6367-RX,03G-P4-6567-RX,03G-P4-6765-RX,03G-P4-6767-RX,11G-P4-5390-RX,11G-P4-6390-RX,11G-P4-6391-RX,11G-P4-6393-RX,11G-P4-6591-RX,11G-P4-6593-RX,11G-P4-6593-RX,11G-P4-6598-RX,11G-P4-6693-RX,11G-P4-6693-RX,11G-P4-6693-RX,11G-P4-6693-RX,11G-P4-6693-RX,11G-P4-6693-RX,11G-P4-6694-RX,11G-P4-6696-RX,11G-P4-6698-RX,11G-P4-6796-RX,11G-P4-6796-RX,11G-P4-6796-RX,11G-P4-6796-RX,11G-P4-6796-RX,11G-P4-6796-RX,11G-P4-6797-RX,11G-P4-6797-RX,08G-P4-5180-RX,08G-P4-5182-RX,08G-P4-5184-RX,08G-P4-5186-RX,08G-P4-6180-RX,08G-P4-6181-RX,08G-P4-6183-RX,08G-P4-6188-RX,08G-P4-6282-RX,08G-P4-6283-RX,08G-P4-6284-RX,08G-P4-6286-RX,08G-P4-6288-RX,08G-P4-6299-RX,08G-P4-6386-RX,08G-P4-6581-RX,08G-P4-6582-RX,08G-P4-6583-RX,08G-P4-6585-RX,08G-P4-6684-RX,08G-P4-6686-RX'
}, (items) => {
	modelNumbers = items.modelNumbers.replace(" ", "").split(",");
	console.log("modelNumbers", modelNumbers);

	const cardList = document.querySelector("#ctl00_LFrame_prdList_rlvProdList_ctrl0_pnlGroupContainer");

	// good cards come at the bottom, so start there
	const cards = [...cardList.children].reverse();

	modelNumbers.forEach(model => {
		cards.forEach(card => {
			const modelNumber = card.querySelector("p.pl-list-pn").textContent.replace("P/N: ", "");
			if (model === modelNumber) {
				chrome.storage.sync.set({
					modelNumbers: modelNumbers.filter(item => item !== modelNumber).join(",")
				});

				addToCart(card, modelNumber);
			}
		});
	});

	chrome.runtime.sendMessage({ message: 'canRefreshBStock' },
		(response) => {
			if (response) {
				setTimeout(() => window.location.reload(), 5000);
			} else {
				setTimeout(() => window.location.href = "https://discord.com/channels/354382386554863627/904000318495399967", 5000);
			}
		});
});